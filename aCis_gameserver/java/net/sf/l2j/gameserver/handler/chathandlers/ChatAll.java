package net.sf.l2j.gameserver.handler.chathandlers;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;

import net.sf.l2j.commons.pool.ConnectionPool;

import net.sf.l2j.gameserver.data.xml.ItemData;
import net.sf.l2j.gameserver.enums.FloodProtector;
import net.sf.l2j.gameserver.enums.SayType;
import net.sf.l2j.gameserver.handler.IChatHandler;
import net.sf.l2j.gameserver.model.actor.Player;
import net.sf.l2j.gameserver.model.events.TextCommandHandler;
import net.sf.l2j.gameserver.model.item.kind.Item;
import net.sf.l2j.gameserver.model.item.kind.Weapon;
import net.sf.l2j.gameserver.network.serverpackets.CreatureSay;
import net.sf.l2j.gameserver.network.serverpackets.NpcHtmlMessage;

public class ChatAll implements IChatHandler
{
	private static final SayType[] COMMAND_IDS =
	{
		SayType.ALL
	};
	
	@Override
	public void handleChat(SayType type, Player player, String target, String text)
	{
		if (!player.getClient().performAction(FloodProtector.GLOBAL_CHAT))
			return;
		
		if (TextCommandHandler.process(text, player))
			return;
		
		// Ranking Weapons
		if (text.equals(".weapons"))
		{
			NpcHtmlMessage htm = new NpcHtmlMessage(5);
			StringBuilder tb = new StringBuilder("<html><head><title>Weapons Ranking</title></head><body><center><img src=\"L2UI.SquareBlank\" width=300 height=0><br1><center><table width=315 bgcolor=000000><tr><td></td></tr><tr><td><center><font color=LEVEL>Ranking Weapons Enchants</font></center></td></tr><tr><td></td></tr></table><br1><center><img src=\"L2Myth.breaker\" width=256 height=16></center><br1><center><table width=95%><tr><td><center><font color=FF0000>[ Player's Name ]</font></center></td><td><center><font color=FF0000>[ Enchanted Weapon ]</font></center></td></tr>");
			try (Connection con = ConnectionPool.getConnection();
				PreparedStatement statement = con.prepareStatement("SELECT owner_id,item_id,enchant_level,char_name FROM items LEFT JOIN characters AS c ON (c.obj_Id=owner_id) WHERE item_id IN (8763,8788,8789,8790,8791,8792,8793,8794,8795,8796,8797,8798,8799,8800,8801,8802,8803,8804,8805,8806,8807,8808,8809,8810,8811,8812,8813,8814,8815,8816,8817,8818,8819,8820,8821,8822,8823,8824,8825,8826,8827,8828,8829,8830,8831,8832,8833,8834,8835,8836,8837,8838,8839,8840,8841,8842,8843,8844,8845,8846,8847,8848,8849,8850,8851,8852,8853,8854,8855,8856,8857,8858,8859,8860,8861,8862,8863,8864,8865,8866,8867,8926,8927,8928,8929,8930,8931,8932,8933,8934,8935,8937,8938,8972,8973,8974,8975,8976,8977,8978,8979,8980,8981,8982,8983,8984,8985,8986,8987,8988,8989,8990,8991,8992,8993,8994,8995,8996,8997,8998,8999,9000,9001,9002,9003,9004,9005,9006,9007,9008,9009,9010,9011,9012,9013,9014,9015,9016,9017,9018,9020,9021,9022,9023,9024,9025,9026,9027,9028,9029,9136,9137,9140,9141,9400,9401,9402,9403,9404,9405,9406,9407,9408,9409,9410,9411,9412,9413,9414,9415,9416,9417,9418,9419,9420,9421,9422,9423,9424,9425,9426,9427,9428,9429,9430,9431,9432,9433,9434,9435,9436,9437,9438,9439,9440,9441,9442,9443,9444,9445,9446,9447,9448,9449,9450,9451,9452,9453,9454,9455,9456,9457,9458,9459,9460,9461,9462,9463,9464,9465,9466,9467,9468,9469,9470,9471,9472,9473,9474,9475,9476,9477,9478,9479,11000,11001,11002,11003,11004,11005,11006,11007,11008,11009,11010,11011,11012,11013,11014,11015,11016,11017,11018,11019,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,738,743,744,747,748,749,754,946,975,981,989,1142,1181,1182,1213,1295,1296,1297,1298,1299,1300,1301,1302,1303,1304,1305,1306,1307,1333,1376,1471,1472,1510,1511,1660,2368,2369,2370,2371,2372,2373,2374,2499,2500,2501,2502,2503,2504,2505,2507,2516,2517,2518,2519,2520,2521,2522,2523,2524,2525,2526,2527,2528,2529,2530,2531,2532,2533,2534,2535,2536,2537,2538,2539,2540,2541,2542,2543,2544,2545,2546,2547,2548,2549,2550,2551,2552,2553,2554,2555,2556,2557,2558,2559,2560,2561,2562,2563,2564,2565,2566,2567,2568,2569,2570,2571,2572,2573,2574,2575,2576,2577,2578,2579,2580,2581,2582,2583,2584,2585,2586,2587,2588,2589,2590,2591,2592,2593,2594,2595,2596,2597,2598,2599,2600,2601,2602,2603,2604,2605,2606,2607,2608,2609,2610,2611,2612,2613,2614,2615,2616,2617,2618,2619,2620,2621,2622,2623,2624,2625,2626,2915,3026,3027,3028,3029,3439,3471,3902,3903,3904,3905,3906,3907,3908,3909,3910,3911,3919,3920,3921,3922,3923,3924,3925,3937,3938,3939,4027,4028,4202,4219,4220,4221,4233,4237,4238,4665,4681,4682,4683,4684,4685,4686,4687,4688,4689,4690,4691,4692,4693,4694,4695,4696,4697,4698,4699,4700,4701,4702,4703,4704,4705,4706,4707,4708,4709,4710,4711,4712,4713,4714,4715,4716,4717,4718,4719,4720,4721,4722,4723,4724,4725,4726,4727,4728,4729,4730,4731,4732,4733,4734,4735,4736,4736,4737,4738,4739,4740,4741,4742,4743,4744,4745,4746,4747,4748,4749,4750,4751,4752,4753,4754,4755,4756,4757,4758,4759,4760,4761,4762,4763,4764,4765,4766,4767,4768,4769,4770,4771,4772,4773,4774,4775,4776,4777,4778,4779,4780,4781,4782,4783,4784,4785,4786,4787,4788,4789,4790,4791,4792,4793,4794,4795,4796,4797,4798,4799,4800,4801,4802,4803,4804,4805,4806,4807,4808,4809,4810,4811,4812,4813,4814,4815,4816,4817,4818,4819,4820,4821,4822,4823,4827,4825,4826,4827,4828,4829,4830,4831,4832,4833,4834,4835,4836,4837,4838,4839,4840,4841,4842,4843,4844,4845,4846,4847,4848,4849,4850,4851,4852,4853,4854,4855,4856,4857,4858,4859,4860,4861,4862,4863,4864,4865,4866,4867,4868,4869,4870,4871,4872,4873,4874,4875,4876,4877,4878,4879,4880,4881,4882,4883,4884,4885,4886,4887,4888,4889,4890,4891,4892,4893,4894,4895,4896,4897,4898,4899,4900,4901,4903,4904,4905,5127,5128,5129,5130,5130,5131,5132,5133,5176,5177,5178,5179,5180,5181,5187,5188,5189,5190,5191,5217,5233,5284,5285,5256,5596,5597,5598,5599,5600,5601,5602,5603,5604,5605,5606,5607,5608,5609,5610,5611,5612,5613,5614,5615,5616,5617,5618,5619,5620,5621,5622,5623,5624,5625,5626,5627,5628,5629,5630,5631,5632,5633,5634,5635,5636,5637,5638,5639,5640,5641,5642,5643,5644,5645,5646,5647,5648,5649,5704,5705,5706,5791,5792,5793,5794,5795,5796,5797,5798,5800,5801,5802,5817,6307,6308,6309,6310,6311,6312,6313,6314,6315,6347,6348,6349,6354,6355,6356,6357,6358,6359,6364,6365,6366,6367,6368,6369,6370,6371,6372,6529,6530,6531,6532,6533,6534,6579,6580,6581,6582,6583,6584,6585,6586,6587,6588,6589,6590,6591,6592,6593,6594,6595,6596,6597,6598,6599,6600,6601,6602,6603,6605,6606,6607,6608,6609,6610,6611,6612,6613,6614,6615,6616,6617,6618,6619,6620,6621,6715,6716,6717,6718,6719,6720,6722,6723,6917,7058,7560,7575,7576,7577,7578,7701,7702,7703,7704,7705,7706,7707,7708,7709,7710,7711,7712,7713,7714,7715,7716,7717,7718,7719,7720,7721,7722,7723,7724,7810,7811,7812,7813,7814,7815,7816,7817,7818,7819,7820,7821,7822,7823,7824,7825,7826,7827,7828,7829,7830,7831,7832,7833,7834,7880,7881,7882,7883,7884,7885,7886,7887,7888,7889,7890,7891,7892,7893,7894,7895,7896,7897,7898,7899,7900,7901,7902,7903,8102,8103,8104,8105,8106,8107,8108,8109,8110,8111,8112,8113,8114,8115,8116,8117,8118,8119,8120,8121,8122,8123,8124,8125,8126,8127,8128,8129,8130,8131,8132,8133,8134,8135,8136,8137,8138,8139,8140,8141,8142,8143,8144,8145,8146,8147,8148,8149,8150,8151,8152,8190,8203,8204,8205,8206,8207,8208,8209,8211,8212,8213,8214,8215,8216,8217,8218,8219,8220,8221,8222,8350,8527,8528,8529,8530,8531,8532,8533,8576,8577,8578,8579,8580,8581,8582,8583,8584,8585,8586,8587,8588,8589,8590,8591,8678,8679,8680,8681,8682,8683,8684,8685,8686,8687,8688,8689) and c.accesslevel=0 order by enchant_level desc limit 15");
				ResultSet result = statement.executeQuery())
			{
				while (result.next())
				{
					String owner_id = result.getString("owner_id");
					String item_id = result.getString("item_id");
					String item_enchant = result.getString("enchant_level");
					Item item = ItemData.getInstance().getTemplate(Integer.parseInt(item_id));

					try (PreparedStatement charname = con.prepareStatement("SELECT char_name FROM characters WHERE obj_Id="+ owner_id);
						ResultSet result2 = charname.executeQuery())
					{
						while (result2.next())
						{
							String char_name = result2.getString("char_name");
							if (item != null)
							{
								String name = item.getName();
								if (item instanceof Weapon)
									tb.append("<tr><td><center>" + char_name + "</center></td><td><center>" + name + "<font color=LEVEL> +" + item_enchant + "</font></center></td></tr>");
							}
						}
					}
				}
			}
			catch (Exception e)
			{
			}
			tb.append("</table><br>");
		//	tb.append("<center><a action=\"bypass -h voiced_ranking\"><font color=\"LEVEL\">Back to Ranking</font></a></center>");
			tb.append("</body></html>");

			htm.setHtml(tb.toString());
			player.sendPacket(htm);
			return;
		}
		
		final CreatureSay cs = new CreatureSay(player, type, text);
		for (Player knownPlayer : player.getKnownTypeInRadius(Player.class, 1250))
			knownPlayer.sendPacket(cs);
		
		player.sendPacket(cs);
	}
	
	@Override
	public SayType[] getChatTypeList()
	{
		return COMMAND_IDS;
	}
}